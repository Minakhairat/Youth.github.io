<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Ninety-Nine</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet" />
  <style>
    :root{ --primary:#1b335f; --accent:#e5c558; --bg:#f9f9fb; --card:#fff; --text:#111; --muted:#6b7280; --ok:#16a34a; --warn:#ca8a04; --danger:#dc2626; }
    :root[data-theme="dark"]{ --bg:#0f1115; --card:#161a22; --text:#e7e7ea; --muted:#9aa3b2; }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Cairo',sans-serif;background:var(--bg);color:var(--text);transition:background .3s,color .3s}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px;background:var(--card);border-bottom:1px solid #0002;position:sticky;top:0;z-index:10}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{height:50px;width:50px;border-radius:10px;border:2px solid var(--accent);object-fit:contain;background:#fff}
    .nav{display:flex;gap:12px;justify-content:center;margin:12px;flex-wrap:wrap}
    .nav button{padding:10px 14px;border-radius:10px;border:1px solid #0002;background:var(--card);cursor:pointer;font-weight:800;color:var(--text)}
    .nav button.active{background:var(--accent);color:#000}
    .container{padding:16px;max-width:1200px;margin:auto}
    .card{background:var(--card);border:1px solid #0002;border-radius:16px;box-shadow:0 6px 20px #0002;margin-bottom:20px;overflow:hidden}
    .card-h{padding:14px 20px;font-weight:900;background:linear-gradient(90deg,var(--primary),var(--accent));color:#000; -webkit-background-clip:text; -webkit-text-fill-color:transparent;}
    .card-h::before{content:'';display:block;height:3px;background:linear-gradient(90deg,var(--primary),var(--accent))}
    .card-b{padding:16px}
    .btn{background:var(--primary);color:#fff;padding:10px 16px;border:none;border-radius:10px;font-weight:800;cursor:pointer}
    .btn:hover{filter:brightness(1.05)}
    .btn-outline{background:transparent;border:2px solid var(--primary);color:var(--primary)}
    .btn-ghost{background:transparent;border:1px dashed #0003;color:var(--text)}
    .btn-danger{background:var(--danger);color:#fff}
    .input{padding:10px;border:1px solid #0002;border-radius:10px;background:var(--card);color:var(--text)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .hint{color:var(--muted);font-size:13px}
    .theme-toggle{cursor:pointer;font-size:14px;border:none;background:var(--accent);padding:6px 10px;border-radius:8px;font-weight:700}
    .table-wrap{border:1px solid #0002;border-radius:12px;overflow:auto;max-height:60vh}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:920px;color:var(--text)}
    th,td{padding:12px;text-align:start;border-bottom:1px solid #0002}
    thead th{background:#f3f4f6;color:#111;position:sticky;top:0;z-index:1}
    [data-theme="dark"] thead th{background:#1f2635;color:#e7e7ea}
    tbody tr:nth-child(odd){background:#fafafa}
    [data-theme="dark"] tbody tr:nth-child(odd){background:#121a2a}
    tbody tr:hover{background:#f0f0f0}
    [data-theme="dark"] tbody tr:hover{background:#0f1726}
    img.avatar{width:44px;height:44px;border-radius:10px;object-fit:cover;border:2px solid var(--accent)}
    a.tel{color:inherit;text-decoration:underline dotted}
    @media(max-width:768px){
      table{min-width:unset}
      thead{display:none}
      tbody tr{display:grid;grid-template-columns:1fr;gap:8px;border:1px solid #0002;border-radius:12px;margin:10px 0;padding:12px;background:var(--card)}
      td{border:none;padding:6px 0}
      td::before{content:attr(data-label) ' : ';font-weight:900;color:var(--muted)}
    }
    .stats-bar{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin:12px 0}
    .stat-box{background:var(--card);border:1px solid #0002;border-radius:12px;padding:10px;text-align:center;box-shadow:0 2px 8px #0001}
    .stat-box h3{margin:0;font-size:12px;color:var(--muted)}
    .stat-box div{font-size:20px;font-weight:900}
    .error{padding:10px;border:1px solid #0002;border-radius:10px;background:#fee2e2;color:#7f1d1d}
    .att-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:900px){.att-grid{grid-template-columns:1fr}}
    .toast-area{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;gap:8px;z-index:50}
    .toast{background:var(--card);color:var(--text);border:1px solid #0002;padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px #0004;min-width:240px;transition:opacity .3s}
    .toast.ok{border-color:var(--ok)} .toast.warn{border-color:var(--warn)} .toast.err{border-color:var(--danger)}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img id="logoImg" class="logo" alt="شعار الخدمة">
      <h2>The Ninety-Nine</h2>
    </div>
    <div class="toolbar">
      <button id="themeBtn" class="theme-toggle">🌙 Dark</button>
      <button id="logoutBtn" class="btn-danger" style="display:none">🚪 خروج</button>
    </div>
  </header>

  <div class="nav">
    <button id="nav-login" class="active">🔐 دخول</button>
    <button id="nav-data">👥 بيانات</button>
    <button id="nav-att">✅ حضور</button>
    <button id="nav-stats">📊 إحصائيات</button>
  </div>

  <!-- Login -->
  <section id="page-login" class="container">
    <div class="card">
      <div class="card-h">🔐 تسجيل الدخول</div>
      <div class="card-b">
        <div class="toolbar">
          <input id="loginUser" class="input" placeholder="اسم المستخدم" style="flex:1">
          <input id="loginMobile" class="input" placeholder="رقم الموبايل" inputmode="numeric" style="flex:1">
          <label class="hint" style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="rememberMe"> تذكّرني على هذا الجهاز</label>
          <button id="loginBtn" class="btn">دخول</button>
        </div>
        <p id="loginMsg" class="hint" style="margin-top:8px"></p>
      </div>
    </div>
  </section>

  <!-- Welcome -->
  <section id="page-welcome" class="container" hidden>
    <div class="card">
      <div class="card-h">👋 مرحبًا بك</div>
      <div class="card-b">
        <h2 id="welcomeName"></h2>
        <p id="welcomeVerse" style="font-weight:700;color:var(--primary)"></p>
      </div>
    </div>
  </section>

  <!-- Data -->
  <section id="page-data" class="container" hidden>
    <div class="card">
      <div class="card-h">👥 بيانات المخدومين</div>
      <div class="card-b">
        <div class="toolbar">
          <select id="groupSelect" class="input"></select>
          <input id="searchInput" class="input" placeholder="ابحث بالاسم/الموبايل/العنوان..." style="flex:1">
          <button id="openSheetBtn" class="btn-outline">✏️ تعديل</button>
          <button id="refreshBtn" class="btn">⟳ تحديث</button>
          <button id="exportAllBtn" class="btn-ghost">⬇️ تصدير CSV الكل</button>
        </div>
        <div id="dataError" class="error" style="display:none"></div>
        <div class="stats-bar" id="topStats"></div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>الاسم</th><th>الأسرة</th><th>الموبايل</th><th>أب الاعتراف</th><th>صورة</th><th>العنوان</th><th>Fun Fact</th><th>ملاحظات</th></tr></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <p class="hint" style="margin-top:8px">جميع الحقوق محفوظة لخدمة شباب كنيسة العذراء مريم و البابا اثناسيوس الرسولي بمدينة نصر.©</p>
      </div>
    </div>
  </section>

  <!-- Attendance -->
  <section id="page-att" class="container" hidden>
    <div class="card">
      <div class="card-h">✅ تسجيل الحضور</div>
      <div class="card-b att-grid">
        <div>
          <div class="toolbar">
            <select id="attGroup" class="input"></select>
            <input id="attSearch" class="input" placeholder="اكتب اسمًا ثم Enter لتمييزه حاضرًا" list="attSuggest" style="flex:1">
            <datalist id="attSuggest"></datalist>
          </div>
          <div class="toolbar" style="margin-top:8px">
            <button id="markAll" class="btn-outline">تحديد الكل</button>
            <button id="clearAll" class="btn-ghost">مسح</button>
            <button id="saveLocal" class="btn">💾 حفظ محلي</button>
            <button id="downloadCsv" class="btn-outline">⬇️ تنزيل CSV</button>
            <button id="uploadDrive" class="btn">⏫ رفع إلى Google Drive</button>
          </div>
          <div class="table-wrap" style="margin-top:10px">
            <table>
              <thead><tr><th>الاسم</th><th>حاضر؟</th></tr></thead>
              <tbody id="attRoster"></tbody>
            </table>
          </div>
        </div>
        <div>
          <div class="toolbar" style="justify-content:space-between"><h3 style="margin:0">حضور اليوم</h3><span class="hint" id="attCountHint">0 مختارين</span></div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>الاسم</th><th>الوقت</th></tr></thead>
              <tbody id="attToday"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Stats -->
  <section id="page-stats" class="container" hidden>
    <div class="card">
      <div class="card-h">📊 التحليلات</div>
      <div class="card-b">
        <div class="toolbar">
          <input id="dateFilter" type="date" class="input">
          <button id="recalc" class="btn-ghost">إعادة الحساب</button>
        </div>
        <div class="stats-bar">
          <div class="stat-box"><h3>جلسات محفوظة</h3><div id="statSessions">0</div></div>
          <div class="stat-box"><h3>حضور اليوم</h3><div id="statPresent">0</div></div>
          <div class="stat-box"><h3>غياب اليوم</h3><div id="statAbsent">0</div></div>
        </div>
        <div class="stats-bar" id="groupRates"></div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>الاسم</th><th>مرات الحضور</th></tr></thead>
            <tbody id="leaderboard"></tbody>
          </table>
        </div>
        <p class="hint">الإحصائيات تعتمد على الجلسات التي يتم حفظها من صفحة الحضور.</p>
      </div>
    </div>
  </section>

  <div id="toastArea" class="toast-area"></div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const on=(el,ev,fn)=>el.addEventListener(ev,fn);
  const escapeHtml=(s)=>String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  const toastArea=$('toastArea');
  function toast(msg,type='ok'){ const t=document.createElement('div'); t.className='toast '+type; t.textContent=msg; toastArea.appendChild(t); setTimeout(()=>{ t.style.opacity='0'; setTimeout(()=>t.remove(),400); },2800); }

  const SHEETS={
    f1b:{id:'1stXYnDRt6bhAnzsPmZI94j7S25tib4mi',edit:'https://docs.google.com/spreadsheets/d/1stXYnDRt6bhAnzsPmZI94j7S25tib4mi/edit',label:'Family 1 Boys'},
    f1g:{id:'1RC1KXwGJWfRDEfrDJaDymoSOoEstnxXP',edit:'https://docs.google.com/spreadsheets/d/1RC1KXwGJWfRDEfrDJaDymoSOoEstnxXP/edit',label:'Family 1 Girls'},
    f2b:{id:'1CsoAWsz_TrLKbpVdcAljJ0IvWGaDYfJL',edit:'https://docs.google.com/spreadsheets/d/1CsoAWsz_TrLKbpVdcAljJ0IvWGaDYfJL/edit',label:'Family 2 Boys'},
    f2g:{id:'1qUsRqsDiDRBZJTNOsGCH4ZBR9s5At2fa',edit:'https://docs.google.com/spreadsheets/d/1qUsRqsDiDRBZJTNOsGCH4ZBR9s5At2fa/edit',label:'Family 2 Girls'},
    f3b:{id:'1NJT8UzKL8NNqYiC90xBnT4rHyy-FtfYi',edit:'https://docs.google.com/spreadsheets/d/1NJT8UzKL8NNqYiC90xBnT4rHyy-FtfYi/edit',label:'Family 3 Boys'},
    f3g:{id:'1H4Okxhz7mvqhqp9GzviqtwXryDOGtme6',edit:'https://docs.google.com/spreadsheets/d/1H4Okxhz7mvqhqp9GzviqtwXryDOGtme6/edit',label:'Family 3 Girls'},
    f4b:{id:'1wrxZMP7rNKRTT6KZHpMKSqyDvNeVRFtm',edit:'https://docs.google.com/spreadsheets/d/1wrxZMP7rNKRTT6KZHpMKSqyDvNeVRFtm/edit',label:'Family 4 Boys'},
    f4g:{id:'1_QN8G0X3Td_uw2HwT38zBsqmfhDto58s',edit:'https://docs.google.com/spreadsheets/d/1_QN8G0X3Td_uw2HwT38zBsqmfhDto58s/edit',label:'Family 4 Girls'}
  };
  const ATTENDANCE_WRITE_URL = 'https://script.google.com/macros/s/AKfycbynMcQb5X4aitbYRT6BeMcH4X7XyJpyagUKp_oHChU/exec';
  const DRIVE_FOLDER_ID = '1HNCjBUhPcAzNfU-omkd8KqF5Zf8gCWTP';

  const USERS=[{user:'admin',mobile:'1234'},{user:'admin1',mobile:'1234'}];
  const VERSES=[
    'كل ما فعلتموه بأحد إخوتي الأصاغر فبي فعلتم (مت 25:40)',
    'اثبتوا فيّ وأنا فيكم (يو 15:4)',
    'اذهبوا وتلمذوا جميع الأمم (مت 28:19)'
  ];

  // Logo – جرّب مسارات مختلفة
  const logo=$('logoImg');
  const LOGO_ID='1A_SZ-BtYHsfCmqBfSP1OwyAeACJ57ISF';
  const logoCandidates=[
    `https://www.google.com/search?sca_esv=c0f7a2a5a5d07d00&sxsrf=AE3TifPy-UuwqQIpHKp9w51Tl5UEyTqfOg:1759147158246&udm=2&fbs=AIIjpHx77SrCLvfzs2LJZHwFvPpr0VfVRoyzOQ_ISZuQXawL9m2C40kZVgStyz3_qRhcj1vdh07QUD_0QM9e5FxYp7byHvV2v3LVxAg5CTV0ZPgixld5kDvXISzWI_iomssFph42nOU9Dn2GlEPKlHh1oHUBMHOM01jleOsv0yS2GscR2IH9j7uPudh_FyW-ZSSnDgAsEnNjqftjQevDdrofinyOZseglfjHZE9VsZH986x9DF-FlFqxhewYC2PJRAbPx1hBuHXrkJb2Iqs89W6_crlCYjbLyQ&q=%D8%B9%D9%84%D8%A7%D9%85%D8%A9+%D8%AC%D9%85%D9%8A%D8%B9+%D8%A7%D9%84%D8%AD%D9%82%D9%88%D9%82+%D9%85%D8%AD%D9%81%D9%88%D8%B8%D8%A9&sa=X&ved=2ahUKEwjjhubr9f2PAxUsVKQEHbBtKvMQtKgLegQIFhAB&biw=1536&bih=756&dpr=1.25#vhid=DAkUZS3mPC4IpM&vssid=mosaic${LOGO_ID}`,
    `https://www.google.com/search?sca_esv=c0f7a2a5a5d07d00&sxsrf=AE3TifPy-UuwqQIpHKp9w51Tl5UEyTqfOg:1759147158246&udm=2&fbs=AIIjpHx77SrCLvfzs2LJZHwFvPpr0VfVRoyzOQ_ISZuQXawL9m2C40kZVgStyz3_qRhcj1vdh07QUD_0QM9e5FxYp7byHvV2v3LVxAg5CTV0ZPgixld5kDvXISzWI_iomssFph42nOU9Dn2GlEPKlHh1oHUBMHOM01jleOsv0yS2GscR2IH9j7uPudh_FyW-ZSSnDgAsEnNjqftjQevDdrofinyOZseglfjHZE9VsZH986x9DF-FlFqxhewYC2PJRAbPx1hBuHXrkJb2Iqs89W6_crlCYjbLyQ&q=%D8%B9%D9%84%D8%A7%D9%85%D8%A9+%D8%AC%D9%85%D9%8A%D8%B9+%D8%A7%D9%84%D8%AD%D9%82%D9%88%D9%82+%D9%85%D8%AD%D9%81%D9%88%D8%B8%D8%A9&sa=X&ved=2ahUKEwjjhubr9f2PAxUsVKQEHbBtKvMQtKgLegQIFhAB&biw=1536&bih=756&dpr=1.25#vhid=DAkUZS3mPC4IpM&vssid=mosaic${LOGO_ID}`,
    `https://www.google.com/search?sca_esv=c0f7a2a5a5d07d00&sxsrf=AE3TifPy-UuwqQIpHKp9w51Tl5UEyTqfOg:1759147158246&udm=2&fbs=AIIjpHx77SrCLvfzs2LJZHwFvPpr0VfVRoyzOQ_ISZuQXawL9m2C40kZVgStyz3_qRhcj1vdh07QUD_0QM9e5FxYp7byHvV2v3LVxAg5CTV0ZPgixld5kDvXISzWI_iomssFph42nOU9Dn2GlEPKlHh1oHUBMHOM01jleOsv0yS2GscR2IH9j7uPudh_FyW-ZSSnDgAsEnNjqftjQevDdrofinyOZseglfjHZE9VsZH986x9DF-FlFqxhewYC2PJRAbPx1hBuHXrkJb2Iqs89W6_crlCYjbLyQ&q=%D8%B9%D9%84%D8%A7%D9%85%D8%A9+%D8%AC%D9%85%D9%8A%D8%B9+%D8%A7%D9%84%D8%AD%D9%82%D9%88%D9%82+%D9%85%D8%AD%D9%81%D9%88%D8%B8%D8%A9&sa=X&ved=2ahUKEwjjhubr9f2PAxUsVKQEHbBtKvMQtKgLegQIFhAB&biw=1536&bih=756&dpr=1.25#vhid=DAkUZS3mPC4IpM&vssid=mosaic${LOGO_ID}`
  ];
  (function setNextLogo(ix=0){
    if(ix>=logoCandidates.length){
      logo.src='data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="https://e7.pngegg.com/pngimages/562/536/png-clipart-copyright-symbol-all-rights-reserved-registered-trademark-symbol-creative-commons-circle-shapes-text-trademark.png" width="100" height="100"><rect width="100" height="100" fill="white"/><text x="50" y="55" text-anchor="middle" font-family="Arial" font-size="14" fill="black">Logo</text></svg>`);
      return;
    }
    logo.src=logoCandidates[ix];
    logo.onerror=()=>setNextLogo(ix+1);
  })();

  // Theme
  const themeBtn=$('themeBtn');
  function setTheme(mode){ document.documentElement.dataset.theme=mode; themeBtn.textContent= mode==='dark'? '☀️ Light':'🌙 Dark'; localStorage.setItem('theme',mode); }
  on(themeBtn,'click',()=>{ const cur=document.documentElement.dataset.theme||'light'; setTheme(cur==='dark'?'light':'dark'); });
  setTheme(localStorage.getItem('theme')||'light');

  // Auth
  const LOGGED_KEY='loggedUser';
  const logoutBtn=$('logoutBtn');
  function showPage(id){ document.querySelectorAll('section').forEach(s=>s.hidden=true); $(id).hidden=false; document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active')); const navBtn=document.getElementById('nav-'+id.split('-')[1]); if(navBtn) navBtn.classList.add('active'); }
  function isLogged(){ return !!(localStorage.getItem(LOGGED_KEY) || sessionStorage.getItem(LOGGED_KEY)); }
  function setLogged(user,remember){ if(remember){ localStorage.setItem(LOGGED_KEY, JSON.stringify(user)); } else { sessionStorage.setItem(LOGGED_KEY, JSON.stringify(user)); } toggleLogout(); }
  function clearLogged(){ localStorage.removeItem(LOGGED_KEY); sessionStorage.removeItem(LOGGED_KEY); toggleLogout(); }
  function toggleLogout(){ logoutBtn.style.display = isLogged()? 'inline-block':'none'; }
  on(logoutBtn,'click',()=>{ clearLogged(); toast('تم تسجيل الخروج','ok'); showPage('page-login'); });

  on($('nav-login'),'click',()=>showPage('page-login'));
  on($('nav-data'),'click',()=>guard(()=>{ showPage('page-data'); ensureData(true); }));
  on($('nav-att'),'click',()=>guard(()=>{ showPage('page-att'); ensureData(false).then(buildAttendanceUI); }));
  on($('nav-stats'),'click',()=>guard(()=>{ showPage('page-stats'); recalcStats(); }));

  on($('loginBtn'),'click',()=>{
    const u=$('loginUser').value.trim(); const m=$('loginMobile').value.trim(); const remember=$('rememberMe').checked;
    const ok=USERS.find(x=>x.user===u&&x.mobile===m);
    if(!ok){ $('loginMsg').textContent='❌ بيانات خاطئة'; toast('بيانات الدخول غير صحيحة','err'); return; }
    setLogged(ok,remember);
    $('welcomeName').textContent='مرحبًا، '+u+' 👋';
    $('welcomeVerse').textContent=VERSES[Math.floor(Math.random()*VERSES.length)];
    $('loginMsg').textContent='';
    toast('تم تسجيل الدخول بنجاح','ok');
    showPage('page-welcome');
    setTimeout(()=>{ showPage('page-data'); ensureData(true); },1000);
  });

  if(isLogged()){ toggleLogout(); showPage('page-data'); ensureData(true); } else { showPage('page-login'); }
  function guard(fn){ if(!isLogged()){ toast('من فضلك سجّل الدخول أولًا','warn'); showPage('page-login'); return; } fn(); }

  // Data
  function fillGroups(){
    const opts=Object.entries(SHEETS).map(([k,v])=>`<option value="${k}">${v.label}</option>`).join('');
    $('groupSelect').innerHTML=opts; $('attGroup').innerHTML=opts;
  }
  fillGroups();

  const cache={}; let activeGroup='f1b';
  const csvUrl=(id)=>`https://docs.google.com/spreadsheets/d/${id}/export?format=csv`;
  on($('groupSelect'),'change',()=>{ activeGroup=$('groupSelect').value; ensureData(true); });
  on($('refreshBtn'),'click',()=>{ delete cache[activeGroup]; ensureData(true); });
  on($('openSheetBtn'),'click',()=> window.open(SHEETS[activeGroup].edit,'_blank'));
  on($('exportAllBtn'),'click',exportAllCSV_UTF8);
  on($('searchInput'),'input',()=>{
    const base=cache[activeGroup]||[];
    const q=$('searchInput').value.trim().toLowerCase();
    if(!q) return renderTable(base);
    const f=base.filter(r=> Object.values(r).some(v=> String(v).toLowerCase().includes(q)));
    renderTable(f,true);
  });

  const MAP={
    name:['name','الاسم','اسم','full name','student','إسم'],
    family:['family','رقم الأسرة','group','رقم الاسرة'],
    mobile:['mob1','mobile','phone','tel','رقم الموبايل','موبايل','تليفون'],
    father:['أب الاعتراف','اب الاعتراف','confession father','father of confession'],
    photo:['photo','image','avatar','صورة'],
    addressMulti:['address','العنوان','address1','address 1','address2','address 2','street','شارع','city','مدينة','area','حي','region','محافظة'],
    fun:['fun fact','fun','facts','Fun Fact'],
    notes:['notes','ملاحظات','remarks']
  };
  function pick(headers, keys){ keys = keys.map(k=>String(k).toLowerCase()); return headers.find(h=> keys.includes(String(h).toLowerCase()))||null; }

  function parseCSV(csv){
    const rows=[]; let cur='',row=[],q=false;
    for(let i=0;i<csv.length;i++){
      const c=csv[i],n=csv[i+1];
      if(c==='\"'){ if(q&&n==='\"'){ cur+='\"'; i++; } else q=!q; }
      else if(c===','&&!q){ row.push(cur); cur=''; }
      else if((c==='\n'||c==='\r')&&!q){ if(cur!==''||row.length){ row.push(cur); rows.push(row); row=[]; cur=''; } }
      else cur+=c;
    }
    if(cur!==''||row.length){ row.push(cur); rows.push(row); }
    const headers=(rows[0]||[]).map(h=>h.trim());
    const data=rows.slice(1).filter(r=>r.some(x=>String(x).trim()!==''))
      .map(r=>Object.fromEntries(headers.map((h,i)=>[h,(r[i]||'').trim()])));
    return {headers,rows:data};
  }

  async function ensureData(render){
    if(cache[activeGroup]){ if(render) renderTable(cache[activeGroup],false); return; }
    await loadSheet(activeGroup); if(render) renderTable(cache[activeGroup],false);
  }

  async function loadSheet(key){
    try{
      $('dataError').style.display='none';
      const res=await fetch(csvUrl(SHEETS[key].id));
      if(!res.ok) throw new Error('تعذّر جلب البيانات. تأكد أن الشيت Public (Anyone with the link → Viewer).');
      const text=await res.text();
      const ds=parseCSV(text);
      cache[key]=normalize(ds,key);
      toast('تم تحميل '+SHEETS[key].label,'ok');
      renderTopStats();
    } catch(e){
      $('tbody').innerHTML='';
      $('dataError').style.display='block';
      $('dataError').innerHTML = '⚠️ '+escapeHtml(e.message);
      toast('خطأ في تحميل البيانات','err');
    }
  }

  function normalize(ds,key){
    const h=ds.headers; const get=(obj, col)=> col? (obj[col]||'') : '';
    const addrCols = h.filter(x=> MAP.addressMulti.map(a=>a.toLowerCase()).includes(String(x).toLowerCase()));
    const rows = ds.rows.map(r=>{
      const nameCol=pick(h,MAP.name), famCol=pick(h,MAP.family), mobCol=pick(h,MAP.mobile), fathCol=pick(h,MAP.father), photoCol=pick(h,MAP.photo), notesCol=pick(h,MAP.notes);
      const address = addrCols.map(c=>r[c]).filter(Boolean).join(' — ');
      return {
        name:get(r,nameCol),
        family:get(r,famCol)||SHEETS[key].label,
        mobile:get(r,mobCol),
        father:get(r,fathCol),
        photo:toImg(get(r,photoCol)),
        address:address,
        fun:'',
        notes:get(r,notesCol)
      };
    });
    return rows;
  }

  function toImg(val){ const s=String(val||'').trim(); if(!s) return ''; if(/^https?:\/\//.test(s)) return s; const m=s.match(/[\-\w]{25,}/); return m?`https://drive.google.com/uc?export=download&id=${m[0]}`:''; }
  function telLink(raw){ const digits=String(raw||'').replace(/[^\d+]/g,''); return digits? `<a class="tel" href="tel:${digits}">${escapeHtml(raw)}</a>` : (escapeHtml(raw)||'—'); }

  function renderTable(rows){
    const body=$('tbody');
    body.innerHTML=(rows||[]).map(r=>`<tr>
      <td data-label="الاسم">${escapeHtml(r.name)||'—'}</td>
      <td data-label="الأسرة">${escapeHtml(r.family)||'—'}</td>
      <td data-label="الموبايل">${telLink(r.mobile)}</td>
      <td data-label="أب الاعتراف">${escapeHtml(r.father)||'—'}</td>
      <td data-label="صورة">${r.photo?`<img class="avatar" src="${escapeHtml(r.photo)}">`:'—'}</td>
      <td data-label="العنوان">${escapeHtml(r.address)||'—'}</td>
      <td data-label="Fun Fact">${escapeHtml(r.fun)||'—'}</td>
      <td data-label="ملاحظات">${escapeHtml(r.notes)||'—'}</td>
    </tr>`).join('') || `<tr><td colspan="8" class="hint">لا توجد بيانات</td></tr>`;
    renderTopStats();
  }

  function renderTopStats(){
    const bar=$('topStats'); const totals={}; let sum=0;
    for(const k in SHEETS){ const n=(cache[k]?.length||0); totals[k]=n; sum+=n; }
    const boxes = [`<div class="stat-box"><h3>الإجمالي</h3><div>${sum}</div></div>`]
      .concat(Object.keys(SHEETS).map(k=>`<div class="stat-box"><h3>${SHEETS[k].label}</h3><div>${totals[k]||0}</div></div>`));
    bar.innerHTML=boxes.join('');
  }

  // CSV UTF8 + BOM
  function exportAllCSV_UTF8(){
    const all = Object.keys(SHEETS).flatMap(k=> (cache[k]||[]).map(r=>({...r,group:SHEETS[k].label})) );
    if(!all.length){ toast('لا يوجد بيانات للتصدير','warn'); return; }
    const headers=['name','family','mobile','father','photo','address','fun','notes','group'];
    const rows=[headers].concat(all.map(r=> headers.map(h=> String(r[h]||'').replaceAll('"','""'))));
    const csv=rows.map(r=> r.map(x=> x.includes(',')? '"'+x+'"':x).join(',')).join('\n');
    const BOM='\uFEFF';
    const blob=new Blob([BOM,csv],{type:'text/csv;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='all_data.csv'; a.click(); URL.revokeObjectURL(a.href);
    toast('تم تصدير CSV بترميز UTF-8','ok');
  }

  // Attendance
  const SESS_KEY='attendance_sessions_v6';
  function getSessions(){ return JSON.parse(localStorage.getItem(SESS_KEY)||'[]'); }
  function setSessions(v){ localStorage.setItem(SESS_KEY, JSON.stringify(v)); }
  function selKeyFor(group){ return 'att_selected_'+group; }
  function readSel(group){ return new Set(JSON.parse(sessionStorage.getItem(selKeyFor(group))||'[]')); }
  function writeSel(group,set){ sessionStorage.setItem(selKeyFor(group), JSON.stringify([...set])); }

  on($('attGroup'),'change',()=>{ activeGroup=$('attGroup').value; ensureData(false).then(buildAttendanceUI); });
  on($('markAll'),'click',()=>{ document.querySelectorAll('#attRoster input[type="checkbox"]').forEach(c=>{ if(!c.checked){ c.checked=true; togglePresent(c); } }); });
  on($('clearAll'),'click',()=>{ document.querySelectorAll('#attRoster input[type="checkbox"]').forEach(c=>{ if(c.checked){ c.checked=false; togglePresent(c); } }); });
  on($('attSearch'),'change',()=>{ const name=$('attSearch').value.trim(); if(!name) return; const box=[...document.querySelectorAll('#attRoster input')].find(c=>c.dataset.name===name); if(box && !box.checked){ box.checked=true; togglePresent(box); } $('attSearch').value=''; });

  on($('saveLocal'),'click',saveLocalOnly);
  on($('downloadCsv'),'click',downloadCsvOnly);
  on($('uploadDrive'),'click',uploadDriveOnly);

  async function buildAttendanceUI(){
    await ensureData(false);
    const list=cache[activeGroup]||[]; const names=list.map(r=>r.name).filter(Boolean);
    const selected=readSel(activeGroup);
    $('attRoster').innerHTML= names.map(n=>`<tr><td>${escapeHtml(n)}</td><td><input type="checkbox" data-name="${escapeHtml(n)}" ${selected.has(n)?'checked':''}></td></tr>`).join('') || '<tr><td colspan="2" class="hint">لا توجد أسماء</td></tr>';
    $('attSuggest').innerHTML = names.map(n=>`<option value="${escapeHtml(n)}"></option>`).join('');
    $('attToday').innerHTML='';
    selected.forEach(n=>{
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${escapeHtml(n)}</td><td>${new Date().toLocaleTimeString('ar-EG')}</td>`;
      $('attToday').appendChild(tr);
    });
    updateAttCount();
    document.querySelectorAll('#attRoster input[type="checkbox"]').forEach(box=> box.addEventListener('change',()=>togglePresent(box)));
  }

  function togglePresent(box){
    const name=box.dataset.name;
    const selected=readSel(activeGroup);
    if(box.checked){
      selected.add(name);
      const time=new Date().toLocaleTimeString('ar-EG');
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${escapeHtml(name)}</td><td>${time}</td>`;
      $('attToday').appendChild(tr);
    } else {
      selected.delete(name);
      [...document.querySelectorAll('#attToday tr')].forEach(tr=>{ if(tr.firstChild && tr.firstChild.textContent===name){ tr.remove(); } });
    }
    writeSel(activeGroup,selected);
    updateAttCount();
  }
  function updateAttCount(){ const c=document.querySelectorAll('#attToday tr').length; $('attCountHint').textContent=c+' مختارين'; }

  function collectAttendance(){
    const names = Array.from(document.querySelectorAll('#attRoster input')).map(c=>c.dataset.name);
    const present = Array.from(document.querySelectorAll('#attToday tr')).map(tr=> tr.firstChild.textContent);
    const setP=new Set(present);
    const when=new Date().toISOString();
    const rows=[["when","group","name","status"]];
    names.forEach(n=> rows.push([when, SHEETS[activeGroup].label, n, setP.has(n)?'Present':'Absent']));
    return {when,names,present,setP,rows};
  }

  function saveLocalOnly(){
    const {when,names,present}=collectAttendance();
    const entry={id:cryptoRand(),when,group:activeGroup,label:SHEETS[activeGroup].label,present,total:names.length};
    const list=getSessions(); list.unshift(entry); setSessions(list);
    toast('تم الحفظ محليًا للجلسة','ok');
  }

  function downloadCsvOnly(){
    const {rows,when}=collectAttendance();
    const csv=rows.map(r=>r.join(',')).join('\n');
    const BOM='\uFEFF';
    const blob=new Blob([BOM,csv],{type:'text/csv;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`attendance_${activeGroup}_${when.slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(a.href);
    toast('تم تنزيل CSV','ok');
  }

  async function uploadDriveOnly(){
    const {rows,when,names,setP}=collectAttendance();
    const csv=rows.map(r=>r.join(',')).join('\n');

    // 1) المحاولة الأساسية: text/plain (بدون Preflight)
    try{
      await postToSheet_plain({
        when, group:activeGroup, groupLabel:SHEETS[activeGroup].label,
        folderId:DRIVE_FOLDER_ID,
        fileName:`attendance_${activeGroup}_${when.slice(0,10)}.csv`,
        csvText:csv,
        records:names.map(n=>({name:n,status:setP.has(n)?'Present':'Absent'}))
      });
      toast('تم رفع CSV إلى Drive','ok');
      return;
    }catch(e1){
      console.warn('plain fail', e1);
      // 2) محاولة احتياطية: form-urlencoded
      try{
        await postToSheet_form({
          when, group:activeGroup, groupLabel:SHEETS[activeGroup].label,
          folderId:DRIVE_FOLDER_ID,
          fileName:`attendance_${activeGroup}_${when.slice(0,10)}.csv`,
          csvText:csv,
          records:names.map(n=>({name:n,status:setP.has(n)?'Present':'Absent'}))
        });
        toast('تم الرفع (طريقة احتياطية)','ok');
        return;
      }catch(e2){
        console.error('form fail', e2);
        const isFile = location.protocol==='file:';
        const msg = isFile ? 'افتح الصفحة عبر http:// بدل file://.' : 'تحقق من نشر Web App بصلاحية Anyone ومنح إذن Drive (واعمل Authorize أول مرة).';
        toast('فشل الرفع: '+(e2.message||e1.message),'warn');
        toast(msg,'warn');
      }
    }
  }

  // بدون Preflight
  async function postToSheet_plain(payload){
    const controller = new AbortController(); const t=setTimeout(()=>controller.abort(),20000);
    const r = await fetch(ATTENDANCE_WRITE_URL+`?origin=${encodeURIComponent(location.origin)}`,{
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify(payload),
      signal:controller.signal,
      redirect:'follow',
      referrerPolicy:'no-referrer'
    });
    clearTimeout(t);
    const txt=await r.text().catch(()=> '');
    if(!r.ok || !(/^OK/i).test((txt||'').trim() || 'OK')){ throw new Error(`HTTP ${r.status} — ${txt||'no body'}`); }
    return txt;
  }

  // احتياطي: x-www-form-urlencoded
  async function postToSheet_form(payload){
    const body = new URLSearchParams({payload: JSON.stringify(payload)}).toString();
    const controller = new AbortController(); const t=setTimeout(()=>controller.abort(),20000);
    const r = await fetch(ATTENDANCE_WRITE_URL,{
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded;charset=utf-8'},
      body,
      signal:controller.signal,
      redirect:'follow',
      referrerPolicy:'no-referrer'
    });
    clearTimeout(t);
    const txt=await r.text().catch(()=> '');
    if(!r.ok || !(/^OK/i).test((txt||'').trim() || 'OK')){ throw new Error(`HTTP ${r.status} — ${txt||'no body'}`); }
    return txt;
  }

  // Analytics
  on($('recalc'),'click',recalcStats);
  function recalcStats(){
    const list=JSON.parse(localStorage.getItem('attendance_sessions_v6')||'[]');
    $('statSessions').textContent=list.length;
    const selDate = $('dateFilter').value? new Date($('dateFilter').value) : new Date();
    const dayKey=(d)=>`${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
    const targetKey=dayKey(selDate);
    const isSameDay=(iso)=> dayKey(new Date(iso))===targetKey;

    const day=list.filter(e=> isSameDay(e.when));
    const pres=day.reduce((s,e)=>s+e.present.length,0);
    const total=day.reduce((s,e)=>s+e.total,0);
    $('statPresent').textContent=pres; $('statAbsent').textContent=Math.max(total-pres,0);

    const byGroup={};
    day.forEach(e=>{
      if(!byGroup[e.group]) byGroup[e.group]={p:0,t:0,label:e.label};
      byGroup[e.group].p += e.present.length;
      byGroup[e.group].t += e.total;
    });
    $('groupRates').innerHTML = Object.entries(SHEETS).map(([k,v])=>{
      const g=byGroup[k]||{p:0,t:0,label:v.label};
      const rate=g.t? Math.round(100*g.p/g.t) : 0;
      return `<div class="stat-box"><h3>${v.label}</h3><div>${rate}%</div></div>`;
    }).join('');

    const counts={};
    list.forEach(s=> s.present.forEach(n=> counts[n]=(counts[n]||0)+1));
    const rows=Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,200)
      .map(([n,c])=>`<tr><td>${escapeHtml(n)}</td><td>${c}</td></tr>`).join('')
      || '<tr><td colspan="2" class="hint">لا توجد بيانات حضور كافية بعد</td></tr>';
    $('leaderboard').innerHTML=rows;
    toast('تم تحديث التحليلات','ok');
  }

  function cryptoRand(){ const a=new Uint32Array(2); crypto.getRandomValues(a); return a.join('-'); }

  if(location.protocol==='file:'){ toast('افتح عبر http:// لتفادي قيود المتصفح','warn'); }
})();
</script>
</body>

</html>








